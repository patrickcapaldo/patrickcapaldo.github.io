<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>PyPuzzle 02 GIL | Patrick X. Capaldo</title> <meta name="author" content="Patrick X. Capaldo"> <meta name="description" content="How the Global Interpreter Lock (GIL) handles threads."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%9A%80&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://patrickcap.github.io/blog/2024/pypuzzle-02/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Patrick </span>X. Capaldo</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> <div class="post"> <header class="post-header"> <h1 class="post-title">PyPuzzle 02 GIL</h1> <p class="post-meta">April 29, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/python"> <i class="fa-solid fa-hashtag fa-sm"></i> python</a>     ·   <a href="/blog/category/puzzles"> <i class="fa-solid fa-tag fa-sm"></i> puzzles</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This weeks PyPuzzle will help you understand the Global Interpreter Lock (GIL) in Python and how it affects multithreading, especially with CPU-bound tasks.</p> <h2 id="topics-covered">Topics Covered</h2> <ul> <li>Global Interpreter Lock (GIL)</li> <li>Threading and CPU-bound tasks</li> <li>Race conditions</li> </ul> <p>Feel free to use an online Python compiler and interpreter like [this] (https://www.online-python.com/) to try running the code yourself. The answer is supplied below the code.</p> <h2 id="question">Question</h2> <p>Given the following code, what do you expect the final value of <code class="language-plaintext highlighter-rouge">counter</code> to be after both threads finish? Run the code multiple times to observe any variations. What does this tell you about the GIL’s impact on multithreading in Python?</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="c1"># Global counter
</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increment</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">counter</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">run_threads</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">counter</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># reset the counter before each run
</span>
    <span class="c1"># Create two threads that both increment the counter
</span>    <span class="n">thread1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increment</span><span class="p">)</span>
    <span class="n">thread2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increment</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

    <span class="c1"># Start both threads
</span>    <span class="n">thread1</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">thread2</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># Wait for both threads to complete
</span>    <span class="n">thread1</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
    <span class="n">thread2</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Final counter:</span><span class="sh">"</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Time taken:</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

<span class="c1"># Run the threads
</span><span class="nf">run_threads</span><span class="p">()</span>

</code></pre></div></div> <h2 id="hints">Hints</h2> <ol> <li>Think about the Global Interpreter Lock (GIL): Can both threads execute Python code at exactly the same time?</li> <li>Why might counter not equal 2,000,000, even though each thread attempts to increment it by 1 million?</li> <li>Try running the code multiple times. Does the output stay consistent?</li> <li>Quickly research what a CPU-bound task is. How does it differ from an I/O-bound task?</li> </ol> <h2 id="answer">Answer</h2> <p>Due to the GIL and lack of thread-safety, the expected output (2,000,000) is often not achieved. Instead, you’ll typically see a value lower than 2,000,000 due to race conditions. The threads compete to update <code class="language-plaintext highlighter-rouge">counter</code>, but because of the GIL, only one thread can execute at a time. As they interleave, they may overwrite each other’s updates, resulting in a lower <code class="language-plaintext highlighter-rouge">counter</code> value.</p> <p>Expected output (specific numbers subject to change):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Final counter: 1323157
Time taken: 0.6897156238555908
</code></pre></div></div> <h2 id="learnings">Learnings</h2> <ol> <li>Global Interpreter Lock (GIL): The GIL prevents true parallelism in Python for CPU-bound tasks because only one thread can execute Python bytecode at a time.</li> <li>CPU-bound Tasks: For tasks that require heavy CPU processing, the GIL limits the benefit of adding more threads. For such tasks, consider using multiprocessing to achieve true parallelism across multiple CPU cores.</li> <li>Race Conditions: Multithreading with shared resources like counter can lead to race conditions, where threads interfere with each other’s updates, producing inconsistent results.</li> <li>Performance and Consistency: The GIL introduces trade-offs between safety and performance in multithreading, especially for CPU-bound tasks, underscoring why threading in Python is more effective for I/O-bound rather than CPU-bound workloads.</li> </ol> <h2 id="further-reading">Further Reading</h2> <ul> <li> <p>CPU-bound tasks are those that spend most of their time waiting for the CPU to finish processing instructions (and thus most of their time hogging the GIL). This is compared to Input/Output (I/O)-bound tasks which spend most of their time waiting for an external event (e.g., network response, reading from a file, database access) to continue the task (and thus can free-up the GIL for a different task).</p> </li> <li> <p>The Global Interpreter Lock (GIL) is a safety mechanism in Python that prevents having multiple threads running at the same time (even if you have multiple CPU cores available where each can hold a single thread at a time).</p> </li> <li> <p>Interestingly, the GIL is mainly a feature of CPython (the default implementation of Python that is written using the C programming language). There are other implementations of Python like PyPy, Jython, and IronPython that are written in other programming languages like Python itself, Java, and C#, respectively. For multithreading, C is not an inherently safe programming language as C allows direct memory access. This means that if two threads were running simultaneously on the same memory, they could access a common memory address that is shared between them. And since processes don’t always take the exact same amount of time to run, this can lead to race conditions and combined with shared memory this would lead to unexpected behaviour, memory leaks, or even crashes. Additionally, since the main implementation of Python, CPython, is based on C, this means that the main implementation of Python is also not inherently safe for multithreading. Thus, the GIL was implemented to ensure only one thread executes at any given time to prevent simultaneous modifications of shared memory.</p> </li> <li> <p>Python could be made safe for multithreading by modifying the underlying CPython code but this would add a significant computational overhead to all Python programs, even the ones that don’t use multithreading (which turns out to be the majority). Being a reliable and thread safe language out-of-the-box is also appealing to extension developers like <code class="language-plaintext highlighter-rouge">NumPy</code> and <code class="language-plaintext highlighter-rouge">Pandas</code> as it means they don’t need to worry about thread safety themselves.</p> </li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/eu-ai-sovereignty/">Europe’s "Sovereign AI" Push</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/pypuzzle-03/">PyPuzzle 03 Yield</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/pypuzzle-04/">PyPuzzle 04 Method Resolution Order</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/tutorial-buffer-overflow-c/">Buffer Overflow in C</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/paths-of-resistance-copy/">Paths of Resistance</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Patrick X. Capaldo. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>